plugins {
    id 'java'
    id 'application'
    id 'com.github.johnrengelman.shadow' version '8.1.1'
    id 'org.openjfx.javafxplugin' version '0.1.0'
}

group = 'org.jwildfire'
version = '9.03-SNAPSHOT'

repositories {
    mavenCentral()
    flatDir { dirs 'lib' }
}

sourceCompatibility = JavaVersion.VERSION_21
targetCompatibility = JavaVersion.VERSION_21

sourceSets {
    main {
        java { srcDir 'src' }
        resources { 
            srcDir 'resources'
            srcDir 'build/generated/resources'
        }
    }
    test {
        java { srcDir 'test/src' }
    }
}

task generateVersionFile {
    doLast {
        def versionFile = file('VERSION.md')
        def versionText = versionFile.exists() ? versionFile.text.trim() : '0.0.0'
        def dateText = new java.text.SimpleDateFormat("dd.MM.yyyy").format(new Date())
        def fullVersion = "V${versionText} (${dateText})"
        
        def outputDir = file('build/generated/resources')
        outputDir.mkdirs()
        def outputFile = file('build/generated/resources/app-version.txt')
        outputFile.text = fullVersion
        println "Generated version file: ${fullVersion}"
    }
}

processResources.dependsOn generateVersionFile

application {
    mainClass = 'org.jwildfire.swing.JWildfire'
}

ext {
    javaFxVersion = '21.0.2'
    lwjglVersion = '3.3.3'
}

javafx {
    version = javaFxVersion
    modules = [ 'javafx.controls', 'javafx.fxml', 'javafx.swing', 'javafx.graphics', 'javafx.web' ]
}

dependencies {
    // Core Dependencies
    implementation 'commons-collections:commons-collections:3.2.2'
    implementation 'com.kitfox.svg:svg-salamander:1.1.3'
    implementation 'colt:colt:1.2.0'
    implementation 'javazoom:jlayer:1.0.1'
    implementation 'com.github.wendykierp:JTransforms:3.1'
    implementation 'org.scijava:jep:2.4.2'
    implementation 'com.jtattoo:JTattoo:1.6.13'
    implementation 'commons-io:commons-io:2.14.0'
    
    // Modernized Dependencies (Moved from lib/)
    implementation 'org.codehaus.janino:janino:3.1.10'
    implementation 'org.joml:joml:1.10.5'
    implementation 'com.cedarsoftware:json-io:4.14.0'
    implementation 'org.slf4j:slf4j-api:2.0.9'
    implementation 'ch.qos.logback:logback-classic:1.4.11'

    // Dependencies from lib folder (Legacy/Not in Maven Central)
    // Exclude JARs that are now handled by Maven
    implementation fileTree(dir: 'lib', include: ['*.jar'], exclude: [
        'lwjgl.jar', 'junit*.jar', 'commons-io*.jar',
        'janino.jar', 'joml*.jar', 'json-io*.jar', 'slf4j*.jar', 'logback*.jar',
        'jtransforms*.jar', 'svgSalamander.jar', 'JTattoo*.jar'
    ])

    // LWJGL
    implementation platform("org.lwjgl:lwjgl-bom:${lwjglVersion}")
    implementation "org.lwjgl:lwjgl"
    implementation "org.lwjgl:lwjgl-glfw"
    implementation "org.lwjgl:lwjgl-opengl"
    implementation "org.lwjgl:lwjgl-opencl"

    // ControlsFX
    implementation 'org.controlsfx:controlsfx:11.2.1'

    // LWJGL Natives (Linux)
    runtimeOnly "org.lwjgl:lwjgl::natives-linux"
    runtimeOnly "org.lwjgl:lwjgl-glfw::natives-linux"
    runtimeOnly "org.lwjgl:lwjgl-opengl::natives-linux"

    // Testing
    testImplementation 'junit:junit:4.13.2'
    testImplementation 'org.junit.jupiter:junit-jupiter:5.10.1'
    testRuntimeOnly 'org.junit.vintage:junit-vintage-engine:5.10.1'
    testRuntimeOnly 'org.junit.platform:junit-platform-launcher'
}

test {
    useJUnitPlatform()
}

tasks.withType(JavaCompile) {
    options.encoding = 'UTF-8'
    options.release = 21
    options.compilerArgs += "--enable-preview"
}

tasks.withType(Test) {
    jvmArgs += "--enable-preview"
}

tasks.withType(JavaExec) {
    jvmArgs += "--enable-preview"
}

tasks.withType(Tar) { duplicatesStrategy = DuplicatesStrategy.EXCLUDE }
tasks.withType(Zip) { duplicatesStrategy = DuplicatesStrategy.EXCLUDE }

run {
    systemProperty "java.library.path", "lib"
}

shadowJar {
    mergeServiceFiles()
}
